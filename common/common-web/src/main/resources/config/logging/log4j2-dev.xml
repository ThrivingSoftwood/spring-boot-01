<?xml version="1.0" encoding="UTF-8"?>
<!--
    Log4j2 è¿›é˜¶ç”Ÿäº§çº§é…ç½®
    ä¼˜åŒ–ç‚¹ï¼šMDC é“¾è·¯è¿½è¸ª | è‡ªåŠ¨æ¸…ç†ç­–ç•¥ | å¼‚æ­¥é«˜æ€§èƒ½é€‚é…
-->
<Configuration status="WARN" monitorInterval="30">

    <Properties>
        <Property name="APP_NAME">${spring:spring.application.name:-springboot-app}</Property>
        <Property name="LOG_HOME">logs/${APP_NAME}</Property>
        <Property name="FILE_NAME">app</Property>

        <!--
            ðŸŽ¨ å‡çº§ç‰ˆæŽ§åˆ¶å°æ ¼å¼ (å·²ä¼˜åŒ–é¡ºåº)ï¼š
            ä¿®æ”¹ç‚¹ï¼šå°† %style{[%X{traceId}]}{cyan} ç§»åˆ°äº† %highlight{%-5level} åŽé¢ã€‚
            è§†è§‰é¡ºåºï¼šæ—¶é—´ -> çº§åˆ« -> [TraceID] -> PID -> ...
        -->
        <!-- ðŸŽ¨ å¼€å‘è€…æŽ§åˆ¶å°æ ¼å¼ï¼šä¿æŒä¸å˜ï¼Œå·²ç»åŒ…å«äº† spanId -->
        <Property name="CONSOLE_PATTERN">%style{%d{yyyy-MM-dd HH:mm:ss.SSS}}{dim} %highlight{%-5level}{FATAL=red bright,
            ERROR=red, WARN=yellow bold, INFO=green, DEBUG=cyan bold, TRACE=blue}
            %style{[%X{traceId}][%X{spanId}]}{cyan} %style{${sys:PID}}{magenta} %style{---}{dim}
            %style{%-40.40c{1.}}{cyan} : %msg%n%style{%throwable}{red}
        </Property>

        <!-- ðŸ“„ ç”Ÿäº§æ–‡ä»¶æ ¼å¼ï¼šè¡¥å…¨äº† [%X{spanId}] -->
        <Property name="LOG_PATTERN">%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%X{traceId}][%X{spanId}] ${sys:PID} ---
            %-40.40c{1.} : %msg%n
        </Property>
    </Properties>

    <Appenders>
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="${CONSOLE_PATTERN}" disableAnsi="false" noConsoleNoAnsi="false"/>
        </Console>

        <!-- Info æ–‡ä»¶ (åŒ…å« INFO, WARN, ERROR) -->
        <RollingRandomAccessFile name="InfoFile"
                                 fileName="${LOG_HOME}/${FILE_NAME}-info.log"
                                 filePattern="${LOG_HOME}/${FILE_NAME}-info-%d{yyyy-MM-dd}-%i.log.gz">
            <!-- âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šç”Ÿäº§çŽ¯å¢ƒè®¾ä¸º falseï¼Œåˆ©ç”¨ buffer æ‰¹é‡å†™å…¥ï¼Œå¤§å¹…å‡å°‘ç£ç›˜ IO -->
            <immediateFlush>false</immediateFlush>
            <bufferSize>262144</bufferSize>

            <PatternLayout pattern="${LOG_PATTERN}"/>

            <Policies>
                <TimeBasedTriggeringPolicy interval="1"/>
                <SizeBasedTriggeringPolicy size="1 GB"/>
            </Policies>

            <!-- ðŸ—‘ï¸ è‡ªåŠ¨æ¸…ç†ç­–ç•¥ï¼šé˜²æ­¢ç£ç›˜æ‰“æ»¡ -->
            <DefaultRolloverStrategy max="50">
                <Delete basePath="${LOG_HOME}/" maxDepth="1">
                    <IfFileName glob="${FILE_NAME}-info-*.log.gz"/>
                    <!-- ä¿ç•™ 30 å¤©çš„æ—¥å¿— -->
                    <IfLastModified age="30d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingRandomAccessFile>

        <!-- Error æ–‡ä»¶ (åªåŒ…å« ERROR) -->
        <RollingRandomAccessFile name="ErrorFile"
                                 fileName="${LOG_HOME}/${FILE_NAME}-error.log"
                                 filePattern="${LOG_HOME}/${FILE_NAME}-error-%d{yyyy-MM-dd}-%i.log.gz">
            <immediateFlush>false</immediateFlush>
            <bufferSize>262144</bufferSize>
            <PatternLayout pattern="${LOG_PATTERN}"/>

            <Filters>
                <ThresholdFilter level="ERROR" onMatch="ACCEPT" onMismatch="DENY"/>
            </Filters>

            <Policies>
                <TimeBasedTriggeringPolicy interval="1"/>
                <SizeBasedTriggeringPolicy size="1 GB"/>
            </Policies>

            <!-- ðŸ—‘ï¸ Error æ—¥å¿—é€šå¸¸æ›´é‡è¦ï¼Œä¿ç•™æ—¶é—´æ›´é•¿æˆ–æ•°é‡æ›´å¤š -->
            <DefaultRolloverStrategy max="50">
                <Delete basePath="${LOG_HOME}/" maxDepth="1">
                    <IfFileName glob="${FILE_NAME}-error-*.log.gz"/>
                    <IfLastModified age="60d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingRandomAccessFile>
    </Appenders>

    <Loggers>
        <Logger name="org.springframework" level="INFO"/>
        <Logger name="org.mybatis" level="DEBUG"/>

        <!-- ä¸šåŠ¡åŒ… Logger -->
        <Logger name="thriving.softwood.mapper" level="DEBUG" additivity="false">
            <AppenderRef ref="Console"/>
        </Logger>

        <!--
            âš¡ å…³é”®ä¼˜åŒ–ï¼šincludeLocation="false"
            å¦‚æžœå¼€å¯äº†å…¨å¼‚æ­¥æ¨¡å¼ (Global Async)ï¼Œå¿…é¡»å…³é—­ä½ç½®ä¿¡æ¯ï¼ˆè¡Œå·ã€æ–¹æ³•åï¼‰ï¼Œ
            å¦åˆ™å¼‚æ­¥æ€§èƒ½ä¼šé€€åŒ–ä¸ºåŒæ­¥æ€§èƒ½çš„ 1/10ï¼
        -->
        <Root level="INFO" includeLocation="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="InfoFile"/>
            <AppenderRef ref="ErrorFile"/>
        </Root>
    </Loggers>

</Configuration>