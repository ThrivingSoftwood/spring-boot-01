<?xml version="1.0" encoding="UTF-8"?>
<!--
    ðŸš€ ç”Ÿäº§çº§é…ç½®è¦ç‚¹ï¼š
    1. packages: å¿…é¡»å¼•å…¥ OTel æ’ä»¶åŒ…ã€‚
    2. Async: ç½‘ç»œæ—¥å¿—å¿…é¡»å¼‚æ­¥ï¼Œé˜²æ­¢ Collector é˜»å¡žæ‹–åž®ä¸šåŠ¡ã€‚
    3. No Layout in OTel: OTel Appender ä¸ä½¿ç”¨ Layoutï¼Œç›´æŽ¥å‘é€ç»“æž„åŒ–æ•°æ®ã€‚
-->
<Configuration status="WARN" monitorInterval="30" packages="io.opentelemetry.instrumentation.log4j.appender.v2_17">

    <Properties>
        <Property name="APP_NAME">${spring:spring.application.name:-springboot-app}</Property>
        <!-- ä¼˜å…ˆè¯»å–ç³»ç»Ÿå±žæ€§ log.homeï¼Œè¯»ä¸åˆ°åˆ™ä½¿ç”¨é»˜è®¤çš„ logs/${APP_NAME} -->
        <Property name="LOG_HOME">${sys:log.home:-logs/${APP_NAME}}</Property>
    </Properties>

    <Appenders>
        <!-- ========================================== -->
        <!-- 1. æŽ§åˆ¶å° (K8s/Docker æŽ¨èä¿ç•™)            -->
        <!-- ========================================== -->
        <Console name="Console" target="SYSTEM_OUT">
            <!-- ç”Ÿäº§çŽ¯å¢ƒåŽ»æŽ‰ %L (è¡Œå·) ä»¥æå‡æ€§èƒ½ -->
            <PatternLayout
                    pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] [%X{traceId}][%X{spanId}] %-5level %logger{36} - %msg%n"/>
        </Console>

        <!-- ========================================== -->
        <!-- 2. æœ¬åœ°æ–‡ä»¶ (ç£ç›˜å…œåº•ï¼Œä»¥é˜²ç½‘ç»œä¸¢å¤±)       -->
        <!-- ========================================== -->
        <RollingRandomAccessFile name="InfoFile" fileName="${LOG_HOME}/app-info.json"
                                 filePattern="${LOG_HOME}/app-info-%d{yyyy-MM-dd}-%i.json.gz">
            <immediateFlush>false</immediateFlush>
            <bufferSize>262144</bufferSize>

            <!-- å†™å…¥ç£ç›˜ä¾ç„¶ä½¿ç”¨ JSON æ¨¡æ¿ï¼Œæ–¹ä¾¿ Filebeat é‡‡é›†æˆ–äººå·¥æŽ’æŸ¥ -->
            <JsonTemplateLayout eventTemplateUri="classpath:config/logging/log4j2-json-layout.json">
                <EventTemplateAdditionalField key="service.name" value="${APP_NAME}"/>
            </JsonTemplateLayout>

            <Policies>
                <TimeBasedTriggeringPolicy interval="1"/>
                <SizeBasedTriggeringPolicy size="1 GB"/>
            </Policies>
            <DefaultRolloverStrategy max="50"/>
        </RollingRandomAccessFile>

        <!-- ========================================== -->
        <!-- 3. OpenTelemetry æ ¸å¿ƒ Appender             -->
        <!-- ========================================== -->
        <!-- æ³¨æ„ï¼šè¿™é‡Œä¸é…ç½® Layoutï¼Œç›´æŽ¥å‘åŽŸç”Ÿ LogRecord ç»™ Collector -->
        <OpenTelemetry name="OTEL_CORE"/>

        <!-- ========================================== -->
        <!-- 4. å¼‚æ­¥åŒ…è£…å™¨ (ç”Ÿäº§çŽ¯å¢ƒå…³é”®ï¼)             -->
        <!-- ========================================== -->
        <!--
             ä½œç”¨ï¼šå°†æ—¥å¿—æ”¾å…¥å†…å­˜é˜Ÿåˆ—ï¼Œç”±ç‹¬ç«‹çº¿ç¨‹å‘é€ç»™ OTel Collectorã€‚
             blocking="false": å¦‚æžœé˜Ÿåˆ—æ»¡äº†ï¼Œç›´æŽ¥ä¸¢å¼ƒæ—¥å¿—ï¼Œç»ä¸é˜»å¡žä¸šåŠ¡çº¿ç¨‹ (Fail-fast)ã€‚
             bufferSize: é˜Ÿåˆ—å¤§å°ï¼Œæ ¹æ®å†…å­˜è°ƒæ•´ã€‚
        -->
        <Async name="OTEL_ASYNC" blocking="false" bufferSize="4096">
            <AppenderRef ref="OTEL_CORE">
                <PatternLayout pattern="%m"/>
            </AppenderRef>
        </Async>

    </Appenders>

    <Loggers>
        <!--
            Root Logger
            includeLocation="false": å†æ¬¡å¼ºè°ƒï¼Œå…³é—­è¡Œå·èŽ·å–ï¼Œæå‡ 10 å€æ€§èƒ½
        -->
        <Root level="INFO" includeLocation="false">
            <!-- è¾“å‡ºåˆ°æŽ§åˆ¶å° (å¯é€‰ï¼Œå¦‚æžœæ˜¯çº¯è™šæœºéƒ¨ç½²å»ºè®®ä¿ç•™) -->
            <AppenderRef ref="Console"/>
            <!-- è¾“å‡ºåˆ°æœ¬åœ°æ–‡ä»¶ (å…œåº•) -->
            <AppenderRef ref="InfoFile"/>
            <!-- ðŸš€ å¼‚æ­¥å‘é€åˆ° Elasticsearch -->
            <AppenderRef ref="OTEL_ASYNC"/>
        </Root>
    </Loggers>

</Configuration>